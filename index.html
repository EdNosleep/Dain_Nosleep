<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Coin Spinner v9.4 MOBILE ULTRA SMOOTH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      outline: none;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: url("background.png") center center / cover no-repeat fixed;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      font-family: sans-serif;
    }
    #coin-wrap {
      position: relative;
      width: 170px;
      height: 170px;
      cursor: pointer;
      will-change: transform;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      transition: transform 0.15s ease-out;
    }
    .coin-face, .coin-edge {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      will-change: transform, opacity, filter;
    }
    .coin-edge {
      opacity: 0;
      transition: opacity 0.08s linear;
      transform-origin: center;
    }
    #inspector {
      position: fixed;
      left: 0; right: 0; bottom: -78vh; height: 78vh;
      background: rgba(12,12,14,0.92);
      backdrop-filter: blur(6px);
      color: #f1f1f1;
      border-top: 1px solid rgba(255,255,255,0.03);
      padding: 10px 14px 80px;
      overflow-y: auto;
      transition: bottom 0.3s ease;
      z-index: 10;
      font-size: .78rem;
    }
    #inspector.active { bottom: 0; }
    #toggle {
      position: fixed;
      right: 14px;
      bottom: 14px;
      width: 52px; height: 52px;
      border-radius: 50%; border: none;
      background: rgba(0,0,0,0.6);
      color: #fff; font-size: 24px;
      cursor: pointer; z-index: 11;
    }
    .control { margin-bottom: 10px; }
    .control label { display:block; margin-bottom:3px; }
    .control input[type=range] { width:100%; }
    .val { font-size: .65rem; opacity: .6; margin-top: 2px; }
  </style>
</head>
<body>

<div id="coin-wrap">
  <img id="coinFace" class="coin-face" src="coin_obverse.png" alt="coin">
  <img id="coinEdge" class="coin-edge" src="coin_edge.png" alt="edge">
</div>

<button id="toggle">⚙️</button>
<div id="inspector">
  <h3>Основное</h3>
  <div class="control"><label>Размер монетки (px)</label><input id="coinSize" type="range" min="100" max="500" value="170"><div class="val" id="coinSizeVal">Текущее: 170</div></div>
  <div class="control"><label>Толщина ребра</label><input id="edgeWidth" type="range" min="0.01" max="0.4" value="0.10" step="0.01"><div class="val" id="edgeWidthVal">Текущее: 0.10</div></div>
  <div class="control"><label>Базовая скорость вращения</label><input id="baseSpeed" type="range" min="5" max="200" value="75"><div class="val" id="baseSpeedVal">Текущее: 75</div></div>
  <h3>Прыжок и бросок</h3>
  <div class="control"><label>Высота прыжка (px)</label><input id="jumpHeight" type="range" min="10" max="400" value="60"><div class="val" id="jumpHeightVal">Текущее: 60</div></div>
  <div class="control"><label>Глубина приземления (px)</label><input id="landingDepth" type="range" min="0" max="80" value="50"><div class="val" id="landingDepthVal">Текущее: 50</div></div>
  <div class="control"><label>Длительность прыжка (сек)</label><input id="jumpDuration" type="range" min="0.1" max="2" value="0.2" step="0.05"><div class="val" id="jumpDurationVal">Текущее: 0.2</div></div>
  <div class="control"><label>Длительность ускорения (сек)</label><input id="accelDuration" type="range" min="0.1" max="2" value="0.2" step="0.05"><div class="val" id="accelDurationVal">Текущее: 0.2</div></div>
  <div class="control"><label>Длительность броска (сек)</label><input id="spinDuration" type="range" min="0.2" max="4" value="1.2" step="0.1"><div class="val" id="spinDurationVal">Текущее: 1.2</div></div>
  <div class="control"><label>Скорость при ускорении</label><input id="boostSpeed" type="range" min="100" max="4000" value="1600" step="50"><div class="val" id="boostSpeedVal">Текущее: 1600</div></div>
  <div class="control"><label>Длительность замедления (сек)</label><input id="slowDuration" type="range" min="0.1" max="3" value="2.4" step="0.1"><div class="val" id="slowDurationVal">Текущее: 2.4</div></div>
  <div class="control"><label>Длительность паузы (сек)</label><input id="pauseDuration" type="range" min="0" max="3" value="0.5" step="0.1"><div class="val" id="pauseDurationVal">Текущее: 0.5</div></div>
  <h3>Результат</h3>
  <div class="control"><label>Шанс выпадения орла (0–1)</label><input id="headsChance" type="range" min="0" max="1" value="0.5" step="0.01"><div class="val" id="headsChanceVal">Текущее: 0.5</div></div>
</div>

<script>
const radSpeed=Math.PI/180,twoPI=Math.PI*2;
const coinWrap=document.getElementById("coin-wrap"),faceEl=document.getElementById("coinFace"),edgeEl=document.getElementById("coinEdge");
const IMG_OBVERSE="coin_obverse.png",IMG_REVERSE="coin_reverse.png",IMG_EDGE="coin_edge.png";
[IMG_OBVERSE,IMG_REVERSE,IMG_EDGE].forEach(s=>{const i=new Image();i.src=s;});
const params={coinSize:170,edgeWidth:0.10,baseSpeed:75,jumpHeight:60,landingDepth:50,jumpDuration:0.2,accelDuration:0.2,spinDuration:1.2,boostSpeed:1600,slowDuration:2.4,pauseDuration:0.3,headsChance:0.5};
let angle=0,lastTime=performance.now(),currentFace=IMG_OBVERSE,spinSpeed=params.baseSpeed,activeAnim=null;
coinWrap.style.width=params.coinSize+"px";coinWrap.style.height=params.coinSize+"px";

const inspector=document.getElementById("inspector");document.getElementById("toggle").onclick=()=>inspector.classList.toggle("active");
function setVal(id,v){const el=document.getElementById(id);if(el)el.textContent="Текущее: "+v;}
function bind(id,h){const el=document.getElementById(id);if(!el)return;el.addEventListener("input",e=>h(+e.target.value));}
Object.keys(params).forEach(k=>{bind(k,v=>{params[k]=v;setVal(k+"Val",v);if(k==="coinSize"){coinWrap.style.width=v+"px";coinWrap.style.height=v+"px";}if(k==="baseSpeed"&&!activeAnim)spinSpeed=v;});});

function loop(now){
  const dt=(now-lastTime)/1000;lastTime=now;
  angle=(angle+spinSpeed*radSpeed*dt)%twoPI;
  const c=Math.cos(angle),absC=Math.abs(c),scaleX=Math.max(absC,0.04);
  const faceBrightness=1+params.lightIntensity*Math.abs(c||1);
  faceEl.style.transform=`scaleX(${scaleX})`;
  faceEl.style.filter=`brightness(${faceBrightness})`;
  if(absC<params.edgeWidth){
    const t=1-(absC/params.edgeWidth);
    edgeEl.style.opacity=t;
    edgeEl.style.transform=`scaleX(0.6)`;
    edgeEl.style.filter=`brightness(${1+params.lightIntensity*t*0.7})`;
  } else edgeEl.style.opacity=0;
  const needObverse=c>=0,needSrc=needObverse?IMG_OBVERSE:IMG_REVERSE;
  if(currentFace!==needSrc&&absC>params.edgeWidth+0.01){faceEl.src=needSrc;currentFace=needSrc;}
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

coinWrap.addEventListener("click",()=>{if(activeAnim)activeAnim.cancelled=true;startSpinSequence();});

async function startSpinSequence(){
  const token={cancelled:false};activeAnim=token;
  coinWrap.style.transform="translateY(0)";spinSpeed=params.baseSpeed;

  const accel=animateOver(params.accelDuration,t=>{spinSpeed=lerp(params.baseSpeed,params.boostSpeed,easeOutQuad(t));},token);
  const jumpUp=animateOver(params.jumpDuration/2,t=>{const y=-params.jumpHeight*Math.sin(t*Math.PI/2);coinWrap.style.transform=`translateY(${y}px)`;},token);
  await Promise.all([accel,jumpUp]);
  await animateOver(params.jumpDuration/2,t=>{const y=-params.jumpHeight*Math.cos(t*Math.PI/2);coinWrap.style.transform=`translateY(${y}px)`;},token);
  await animateOver(0.2,t=>{const y=Math.sin(t*Math.PI)*params.landingDepth;coinWrap.style.transform=`translateY(${y}px)`;},token);
  coinWrap.style.transform="translateY(0)";
  await wait(params.spinDuration,token);
  await animateOver(params.slowDuration,t=>{const eased=1-easeOutCubic(t);spinSpeed=params.boostSpeed*eased;},token);
  spinSpeed=0;

  const heads=Math.random()<params.headsChance;
  const target=heads?0:Math.PI;
  const startAngle=angle%twoPI;
  await animateOver(0.4,t=>{angle=lerpAngleRad(startAngle,target,easeOutQuad(t));},token);
  await wait(params.pauseDuration,token);

  // ✅ мягкий старт из анфас, не с ребра
  await animateOver(1.0,t=>{spinSpeed=params.baseSpeed*t;},token);
  spinSpeed=params.baseSpeed;
  if(token.cancelled)return;
}

function animateOver(d,cb,tk){return new Promise(r=>{const s=performance.now();function f(n){if(tk.cancelled)return r();let t=(n-s)/(d*1000);if(t>1)t=1;cb(t);if(t<1)requestAnimationFrame(f);else r();}requestAnimationFrame(f);});}
function wait(s,tk){return new Promise(r=>{const e=performance.now()+s*1000;function c(n){if(tk.cancelled)return r();if(n<e)requestAnimationFrame(c);else r();}requestAnimationFrame(c);});}
function easeOutCubic(x){return 1-Math.pow(1-x,3);}
function easeOutQuad(x){return 1-(1-x)*(1-x);}
function lerp(a,b,t){return a+(b-a)*t;}
function lerpAngleRad(a,b,t){let d=(b-a+twoPI)%twoPI;if(d>Math.PI)d-=Math.PI;return a+d*t;}
</script>
</body>
</html>