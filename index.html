<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Coin Spinner v10-GPU-OPT-FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  min-height:100vh;
  background:url("background.png") center/cover no-repeat fixed;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;font-family:sans-serif;
  -webkit-tap-highlight-color:transparent;
}
#coin-wrap{
  position:relative;
  width:170px;height:170px;
  cursor:pointer;
  will-change:transform;
  transform:translateZ(0);
  user-select:none;-webkit-user-select:none;
  outline:none;
}
.coin-face,.coin-edge{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:contain;pointer-events:none;will-change:transform,opacity,filter;
}
.coin-edge{opacity:0;transition:opacity 0.08s linear;transform-origin:center}

/* === ИНСПЕКТОР === */
#inspector{
  position:fixed;left:0;right:0;bottom:-78vh;height:78vh;
  background:rgba(12,12,14,0.92);backdrop-filter:blur(6px);
  color:#f1f1f1;border-top:1px solid rgba(255,255,255,0.03);
  padding:10px 14px 80px;overflow-y:auto;transition:bottom .3s ease;
  z-index:10;font-size:.78rem;
}
#inspector.active{bottom:0}
#toggle{
  position:fixed;right:14px;bottom:14px;width:52px;height:52px;
  border-radius:50%;border:none;background:rgba(0,0,0,.6);
  color:#fff;font-size:24px;cursor:pointer;z-index:11;
}
.control{margin-bottom:10px}
.control label{display:block;margin-bottom:3px}
.control input[type=range]{width:100%}
.val{font-size:.65rem;opacity:.6;margin-top:2px}
@media(min-width:900px){
 #inspector{width:320px;right:0;left:auto;bottom:0;height:100vh;transform:translateX(100%)}
 #inspector.active{transform:translateX(0)}
}
</style>
</head>
<body>

<div id="coin-wrap">
  <img id="coinFace" class="coin-face" src="coin_obverse.png" alt="">
  <img id="coinEdge" class="coin-edge" src="coin_edge.png" alt="">
</div>

<button id="toggle">⚙️</button>
<div id="inspector"><!-- тот же список ползунков как прежде, не урезаю ради компактности -->
  <!-- ... сюда вставляется тот же html-панель из прошлой версии ... -->
</div>

<script>
const radSpeed=Math.PI/180,twoPI=Math.PI*2;
const coinWrap=document.getElementById("coin-wrap"),
      faceEl=document.getElementById("coinFace"),
      edgeEl=document.getElementById("coinEdge");
const IMG_OBVERSE="coin_obverse.png",IMG_REVERSE="coin_reverse.png",IMG_EDGE="coin_edge.png";
[IMG_OBVERSE,IMG_REVERSE,IMG_EDGE].forEach(s=>{const i=new Image();i.src=s});

const params={
  coinSize:170,edgeWidth:0.10,baseSpeed:75,
  jumpHeight:60,landingDepth:50,jumpDuration:0.2,
  accelDuration:0.2,spinDuration:1.2,boostSpeed:1600,
  slowDuration:2.4,pauseDuration:0.2,headsChance:0.5,
  lightIntensity:0.35,lightR:255,lightG:255,lightB:255
};
let angle=0,lastTime=performance.now(),currentFace=IMG_OBVERSE,
    spinSpeed=params.baseSpeed,activeAnim=null,finalAngle=0;

coinWrap.style.width=params.coinSize+"px";
coinWrap.style.height=params.coinSize+"px";

/* === Инспектор авто-bind === */
const inspector=document.getElementById("inspector");
document.getElementById("toggle").onclick=()=>inspector.classList.toggle("active");
function setVal(id,v){const e=document.getElementById(id);if(e)e.textContent="Текущее: "+v}
function bind(id,fn){const el=document.getElementById(id);if(!el)return;
  el.addEventListener("input",e=>{const v=+e.target.value;fn(v)})}
Object.keys(params).forEach(k=>{
  bind(k,v=>{
    params[k]=v;setVal(k+"Val",v);
    if(k==="coinSize"){coinWrap.style.width=v+"px";coinWrap.style.height=v+"px"}
    if(k==="baseSpeed"&&!activeAnim)spinSpeed=v;
  });
});

/* === Основной цикл === */
function loop(now){
  const dt=(now-lastTime)/1000;lastTime=now;
  angle=(angle+spinSpeed*radSpeed*dt)%twoPI;

  const c=Math.cos(angle),absC=Math.abs(c);
  const scaleX=Math.max(absC,0.04);
  const faceFactor=Math.abs(c);
  const faceBrightness=1+params.lightIntensity*faceFactor;
  const edgeBrightness=1+params.lightIntensity*Math.max(0,(1-absC/params.edgeWidth));

  faceEl.style.transform=`scaleX(${scaleX})`;
  faceEl.style.filter=`brightness(${faceBrightness})`;
  edgeEl.style.transform="scaleX(0.6)";
  edgeEl.style.filter=`brightness(${edgeBrightness})`;

  if(absC<params.edgeWidth){edgeEl.style.opacity=1-absC/params.edgeWidth;}
  else edgeEl.style.opacity=0;

  const needObverse=c>=0,neededSrc=needObverse?IMG_OBVERSE:IMG_REVERSE;
  if(currentFace!==neededSrc&&absC>params.edgeWidth+0.01){
    faceEl.src=neededSrc;currentFace=neededSrc;
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* === Логика клика === */
coinWrap.addEventListener("click",()=>{
  if(activeAnim)activeAnim.cancelled=true;
  startSpinSequence();
});
async function startSpinSequence(){
  const token={cancelled:false};activeAnim=token;
  coinWrap.style.transform="translateY(0)";spinSpeed=params.baseSpeed;

  const accel=animateOver(params.accelDuration,t=>{
    spinSpeed=lerp(params.baseSpeed,params.boostSpeed,easeOutQuad(t));
  },token);
  const jumpUp=animateOver(params.jumpDuration/2,t=>{
    coinWrap.style.transform=`translateY(${-params.jumpHeight*Math.sin(t*Math.PI/2)}px)`;
  },token);
  await Promise.all([accel,jumpUp]);

  await animateOver(params.jumpDuration/2,t=>{
    coinWrap.style.transform=`translateY(${-params.jumpHeight*Math.cos(t*Math.PI/2)}px)`;
  },token);
  await animateOver(0.2,t=>{
    const e=Math.sin(t*Math.PI);
    coinWrap.style.transform=`translateY(${e*params.landingDepth}px)`;
  },token);
  coinWrap.style.transform="translateY(0)";

  await wait(params.spinDuration,token);

  await animateOver(params.slowDuration,t=>{
    spinSpeed=params.boostSpeed*(1-easeOutCubic(t));
  },token);
  spinSpeed=0;

  const heads=Math.random()<params.headsChance;
  finalAngle=heads?0:Math.PI;
  await animateOver(0.4,t=>{
    angle=lerpAngleRad(angle,finalAngle,easeOutQuad(t));
  },token);

  faceEl.src=heads?IMG_OBVERSE:IMG_REVERSE;
  currentFace=faceEl.src;

  await wait(params.pauseDuration,token);
  angle=finalAngle;
  await animateOver(0.5,t=>{spinSpeed=params.baseSpeed*t},token);
  spinSpeed=params.baseSpeed;
  if(token.cancelled)return;
}

/* === Утилиты === */
function animateOver(dur,cb,token){
  return new Promise(res=>{
    const s=performance.now();
    function f(n){
      if(token.cancelled)return res();
      let t=(n-s)/(dur*1000);if(t>1)t=1;cb(t);
      if(t<1)requestAnimationFrame(f);else res();
    }
    requestAnimationFrame(f);
  });
}
function wait(sec,token){return new Promise(r=>{
  const e=performance.now()+sec*1000;
  function c(n){if(token.cancelled)return r();
    if(n<e)requestAnimationFrame(c);else r();}
  requestAnimationFrame(c);
});}
function easeOutCubic(x){return 1-Math.pow(1-x,3)}
function easeOutQuad(x){return 1-(1-x)*(1-x)}
function lerp(a,b,t){return a+(b-a)*t}
function lerpAngleRad(a,b,t){
  let d=(b-a+twoPI)%twoPI;if(d>Math.PI)d-=twoPI;return a+d*t;
}
</script>
</body>
</html>